<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>StudyPulse â€” AI Quiz & Flashcard Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #13131a;
    --surface2: #1c1c28;
    --border: #2a2a3d;
    --accent: #7c6aff;
    --accent2: #ff6a9b;
    --accent3: #6affca;
    --text: #f0eeff;
    --muted: #7a7a9a;
    --correct: #22c97a;
    --wrong: #ff4f6e;
    --radius: 14px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 50% at 20% 20%, rgba(124,106,255,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 50% 60% at 80% 80%, rgba(255,106,155,0.08) 0%, transparent 60%),
      radial-gradient(ellipse 40% 40% at 60% 10%, rgba(106,255,202,0.06) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 780px;
    margin: 0 auto;
    padding: 32px 20px 80px;
  }

  /* â”€â”€ Header â”€â”€ */
  .header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 40px;
    animation: fadeUp 0.5s ease both;
  }
  .logo {
    width: 40px; height: 40px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .logo-text { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 22px; letter-spacing: -0.5px; }
  .logo-text span {
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }

  /* â”€â”€ Mode Toggle â”€â”€ */
  .mode-toggle {
    display: flex;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 4px;
    gap: 4px;
    margin-bottom: 20px;
    animation: fadeUp 0.5s ease 0.03s both;
  }
  .mode-btn {
    flex: 1;
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    border: none;
    border-radius: 9px;
    padding: 10px 16px;
    cursor: pointer;
    background: transparent;
    color: var(--muted);
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }
  .mode-btn.active {
    background: linear-gradient(135deg, var(--accent), #9b5cff);
    color: #fff;
    box-shadow: 0 2px 12px rgba(124,106,255,0.35);
  }
  .mode-btn:not(.active):hover { color: var(--text); }

  /* â”€â”€ Cards â”€â”€ */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 20px;
  }
  .card-label {
    font-family: 'Syne', sans-serif;
    font-size: 11px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--accent); margin-bottom: 12px;
  }

  /* â”€â”€ API Key â”€â”€ */
  .api-row { display: flex; gap: 10px; align-items: center; }
  .api-status {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--muted); flex-shrink: 0; transition: background 0.3s;
  }
  .api-status.active { background: var(--correct); box-shadow: 0 0 8px var(--correct); }
  .key-toggle {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 18px; padding: 4px; flex-shrink: 0;
  }
  .key-toggle:hover { color: var(--text); }

  /* â”€â”€ Inputs â”€â”€ */
  input[type="text"], input[type="password"], input[type="number"], textarea, select {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    padding: 12px 16px;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input:focus, textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(124,106,255,0.15);
  }
  textarea { resize: vertical; min-height: 200px; line-height: 1.6; font-size: 14px; }
  input[type="number"] { width: 100px; }

  /* â”€â”€ Load session strip â”€â”€ */
  .load-strip {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--surface2);
    border: 1px dashed var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 20px;
    animation: fadeUp 0.5s ease 0.06s both;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  .load-strip:hover { border-color: var(--accent); }
  .load-strip input[type="file"] { display: none; }
  .load-strip-icon { font-size: 22px; flex-shrink: 0; }
  .load-strip-text { flex: 1; }
  .load-strip-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; }
  .load-strip-sub { font-size: 12px; color: var(--muted); margin-top: 2px; }

  /* â”€â”€ Setup row â”€â”€ */
  .setup-row {
    display: flex; gap: 20px;
    align-items: flex-end; flex-wrap: wrap; margin-top: 16px;
  }
  .field-group { display: flex; flex-direction: column; gap: 8px; }
  .field-label { font-size: 13px; font-weight: 500; color: var(--muted); }

  /* â”€â”€ Buttons â”€â”€ */
  .btn {
    font-family: 'Syne', sans-serif;
    font-size: 15px; font-weight: 700;
    border: none; border-radius: 10px;
    cursor: pointer; padding: 13px 28px;
    transition: all 0.2s; letter-spacing: 0.3px; white-space: nowrap;
  }
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #9b5cff);
    color: #fff; box-shadow: 0 4px 20px rgba(124,106,255,0.35);
  }
  .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(124,106,255,0.45); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-secondary {
    background: var(--surface2); color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-teal {
    background: linear-gradient(135deg, #1a9e78, #12c99a);
    color: #fff; box-shadow: 0 4px 20px rgba(34,201,122,0.25);
  }
  .btn-teal:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(34,201,122,0.35); }
  .btn-teal:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-ghost {
    background: transparent; color: var(--muted);
    font-size: 13px; padding: 8px 14px;
  }
  .btn-ghost:hover { color: var(--text); }
  .btn-sm { padding: 9px 18px; font-size: 13px; }

  /* â”€â”€ Loading â”€â”€ */
  .loading-screen { text-align: center; padding: 80px 20px; animation: fadeUp 0.4s ease both; }
  .spinner {
    width: 48px; height: 48px;
    border: 3px solid var(--border); border-top-color: var(--accent);
    border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 24px;
  }
  .loading-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; margin-bottom: 8px; }
  .loading-sub { color: var(--muted); font-size: 14px; }

  /* â”€â”€ Progress bar â”€â”€ */
  .progress-wrap { background: var(--surface2); border-radius: 99px; height: 6px; margin-bottom: 32px; overflow: hidden; }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 99px;
    transition: width 0.4s cubic-bezier(0.4,0,0.2,1);
  }
  .progress-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .progress-text { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--muted); }

  /* â”€â”€ Question card â”€â”€ */
  .question-card { animation: fadeUp 0.35s ease both; }
  .question-number { font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin-bottom: 14px; }
  .question-text { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; line-height: 1.4; margin-bottom: 28px; }

  /* â”€â”€ Choices â”€â”€ */
  .choices { display: flex; flex-direction: column; gap: 12px; }
  .choice {
    background: var(--surface2); border: 1.5px solid var(--border);
    border-radius: 12px; padding: 16px 20px;
    cursor: pointer; display: flex; align-items: center; gap: 14px;
    transition: all 0.18s; font-size: 15px; line-height: 1.45;
    text-align: left; width: 100%; color: var(--text);
    font-family: 'DM Sans', sans-serif;
  }
  .choice:hover:not(:disabled) { border-color: var(--accent); background: rgba(124,106,255,0.08); transform: translateX(4px); }
  .choice:disabled { cursor: default; }
  .choice-letter {
    width: 32px; height: 32px; border-radius: 8px;
    background: var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px;
    flex-shrink: 0; transition: all 0.18s;
  }
  .choice.correct { border-color: var(--correct); background: rgba(34,201,122,0.1); }
  .choice.correct .choice-letter { background: var(--correct); color: #000; }
  .choice.wrong { border-color: var(--wrong); background: rgba(255,79,110,0.1); }
  .choice.wrong .choice-letter { background: var(--wrong); color: #fff; }
  .choice.reveal-correct { border-color: var(--correct); background: rgba(34,201,122,0.06); }
  .choice.reveal-correct .choice-letter { background: var(--correct); color: #000; }
  .choice-icon { margin-left: auto; font-size: 18px; flex-shrink: 0; }

  /* â”€â”€ Feedback â”€â”€ */
  .feedback {
    margin-top: 20px; padding: 14px 18px; border-radius: 10px;
    font-size: 14px; font-weight: 500;
    display: flex; align-items: center; gap: 10px;
    animation: fadeUp 0.25s ease both;
  }
  .feedback.correct-fb { background: rgba(34,201,122,0.12); border: 1px solid rgba(34,201,122,0.3); color: #6effc0; }
  .feedback.wrong-fb { background: rgba(255,79,110,0.12); border: 1px solid rgba(255,79,110,0.3); color: #ff8fa8; }

  .next-row { margin-top: 24px; display: flex; justify-content: flex-end; animation: fadeUp 0.3s ease 0.1s both; }

  /* â”€â”€ Results â”€â”€ */
  .results-header { text-align: center; padding: 40px 20px 32px; animation: fadeUp 0.4s ease both; }
  .results-emoji { font-size: 52px; margin-bottom: 16px; }
  .results-title { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; margin-bottom: 8px; }
  .results-sub { color: var(--muted); font-size: 15px; }
  .score-badge {
    display: inline-flex; align-items: center; gap: 8px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 99px; padding: 8px 20px;
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-top: 16px;
  }
  .score-dot { width: 10px; height: 10px; border-radius: 50%; }

  .review-list { display: flex; flex-direction: column; gap: 14px; margin-bottom: 28px; }
  .review-item {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 18px 20px;
    animation: fadeUp 0.4s ease both;
  }
  .review-item.r-correct { border-left: 3px solid var(--correct); }
  .review-item.r-wrong { border-left: 3px solid var(--wrong); }
  .review-q { font-family: 'Syne', sans-serif; font-weight: 600; font-size: 15px; margin-bottom: 10px; display: flex; gap: 10px; align-items: flex-start; }
  .review-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .review-answers { display: flex; flex-direction: column; gap: 5px; font-size: 13px; }
  .review-correct-ans { color: #6effc0; display: flex; gap: 6px; align-items: center; }
  .review-wrong-ans { color: #ff8fa8; display: flex; gap: 6px; align-items: center; }

  .results-actions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin-top: 12px; }

  /* â”€â”€ Study Guide â”€â”€ */
  .study-guide-section { margin: 28px 0; animation: fadeUp 0.4s ease both; }

  /* Collapsible panel */
  .sg-panel {
    background: var(--surface);
    border: 1px solid rgba(34,201,122,0.3);
    border-radius: var(--radius);
    overflow: hidden;
  }
  .sg-panel-header {
    display: flex; align-items: center; gap: 12px;
    padding: 18px 22px;
    background: linear-gradient(135deg, rgba(34,201,122,0.1), rgba(106,255,202,0.05));
    border-bottom: 1px solid rgba(34,201,122,0.2);
    cursor: pointer;
    user-select: none;
    transition: background 0.2s;
  }
  .sg-panel-header:hover { background: linear-gradient(135deg, rgba(34,201,122,0.15), rgba(106,255,202,0.08)); }
  .sg-panel-icon { font-size: 20px; flex-shrink: 0; }
  .sg-panel-title {
    font-family: 'Syne', sans-serif; font-weight: 700; font-size: 15px;
    color: #6effc0; flex: 1;
  }
  .sg-panel-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .sg-chevron {
    font-size: 18px; color: var(--muted);
    transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    flex-shrink: 0;
  }
  .sg-panel.open .sg-chevron { transform: rotate(180deg); }

  .sg-panel-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4,0,0.2,1);
  }
  .sg-panel.open .sg-panel-body { max-height: 2000px; }

  .sg-panel-inner { padding: 24px 22px; }

  /* Loading skeleton */
  .sg-skeleton { display: flex; flex-direction: column; gap: 12px; }
  .sg-skel-bar {
    height: 14px; border-radius: 6px;
    background: linear-gradient(90deg, var(--surface2) 25%, var(--border) 50%, var(--surface2) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.4s infinite;
  }
  .sg-skel-bar.title { height: 18px; width: 55%; margin-bottom: 4px; }
  .sg-skel-bar.short { width: 40%; }
  .sg-skel-bar.med { width: 75%; }
  .sg-skel-bar.full { width: 100%; }
  @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

  /* Spinner inside button */
  .btn-spinner {
    display: inline-block;
    width: 14px; height: 14px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }
  /* Pulsing glow on loading button */
  .btn-teal.loading {
    animation: tealPulse 1.2s ease-in-out infinite;
  }
  @keyframes tealPulse {
    0%, 100% { box-shadow: 0 4px 20px rgba(34,201,122,0.25); }
    50% { box-shadow: 0 4px 32px rgba(34,201,122,0.55), 0 0 0 4px rgba(34,201,122,0.12); }
  }

  /* Study guide content typography */
  .sg-content h3 {
    font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700;
    color: #6effc0; margin: 22px 0 8px; padding-bottom: 6px;
    border-bottom: 1px solid rgba(34,201,122,0.15);
  }
  .sg-content h3:first-child { margin-top: 0; }
  .sg-content p { font-size: 14px; line-height: 1.75; color: #ccc8ee; margin-bottom: 10px; }
  .sg-content ul { padding-left: 20px; margin-bottom: 10px; }
  .sg-content li { font-size: 14px; line-height: 1.75; color: #ccc8ee; margin-bottom: 5px; }
  .sg-content strong { color: var(--text); }
  .sg-content em { color: #b8b0f0; font-style: italic; }

  .sg-divider { height: 1px; background: var(--border); margin: 20px 0; }
  .sg-actions { display: flex; gap: 10px; flex-wrap: wrap; padding-top: 4px; }

  /* â”€â”€ Flashcard â”€â”€ */
  .fc-progress-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .fc-counter { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--muted); }

  .flashcard-scene {
    perspective: 1200px;
    width: 100%; height: 300px;
    margin-bottom: 24px;
    cursor: pointer;
  }
  @media (max-width: 560px) { .flashcard-scene { height: 240px; } }

  .flashcard {
    width: 100%; height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.5s cubic-bezier(0.4,0,0.2,1);
  }
  .flashcard.flipped { transform: rotateY(180deg); }

  .fc-face {
    position: absolute; inset: 0;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    border-radius: var(--radius);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 32px; text-align: center;
  }
  .fc-front {
    background: var(--surface);
    border: 1px solid var(--border);
  }
  .fc-back {
    background: linear-gradient(135deg, rgba(124,106,255,0.15), rgba(255,106,155,0.1));
    border: 1px solid rgba(124,106,255,0.35);
    transform: rotateY(180deg);
  }
  .fc-label {
    font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase;
    color: var(--muted); margin-bottom: 16px;
  }
  .fc-back .fc-label { color: var(--accent); }
  .fc-text {
    font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700;
    line-height: 1.5; color: var(--text);
  }
  .fc-back .fc-text { font-size: 22px; color: var(--accent); }
  .fc-hint { font-size: 12px; color: var(--muted); margin-top: 20px; }

  .fc-nav {
    display: flex; align-items: center; justify-content: center;
    gap: 16px; margin-bottom: 24px;
  }
  .fc-nav-btn {
    width: 44px; height: 44px; border-radius: 50%;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-size: 20px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .fc-nav-btn:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
  .fc-nav-btn:disabled { opacity: 0.3; cursor: default; }
  .fc-flip-hint {
    text-align: center; font-size: 13px; color: var(--muted); margin-bottom: 28px;
  }

  .fc-actions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; padding-bottom: 20px; }

  /* â”€â”€ Error â”€â”€ */
  .error-box {
    background: rgba(255,79,110,0.1); border: 1px solid rgba(255,79,110,0.35);
    border-radius: 10px; padding: 14px 18px;
    font-size: 14px; color: #ff8fa8; margin-top: 12px; display: none;
  }
  .error-box.show { display: block; }

  /* â”€â”€ Screens â”€â”€ */
  .screen { display: none; }
  .screen.active { display: block; }

  /* â”€â”€ Animations â”€â”€ */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes spin { to { transform: rotate(360deg); } }

  .anim-1 { animation: fadeUp 0.5s ease 0.05s both; }
  .anim-2 { animation: fadeUp 0.5s ease 0.1s both; }
  .anim-3 { animation: fadeUp 0.5s ease 0.15s both; }
  .anim-4 { animation: fadeUp 0.5s ease 0.2s both; }

  @media (max-width: 560px) {
    .question-text { font-size: 17px; }
    .choice { font-size: 14px; padding: 14px 16px; }
    .results-title { font-size: 22px; }
    .setup-row { flex-direction: column; align-items: flex-start; }
    input[type="number"] { width: 100%; }
    .fc-text { font-size: 16px; }
    .fc-back .fc-text { font-size: 19px; }
  }
</style>
</head>
<body>
<div class="container">

  <!-- Header -->
  <div class="header">
    <div class="logo">âš¡</div>
    <div class="logo-text"><span>Study</span>Pulse</div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SETUP SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screen-setup" class="screen active">

    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <button class="mode-btn active" id="mode-quiz-btn" onclick="setMode('quiz')">âš¡ Quiz Mode</button>
      <button class="mode-btn" id="mode-fc-btn" onclick="setMode('flashcard')">ğŸƒ Flashcard Mode</button>
    </div>

    <!-- API Key -->
    <div class="card anim-1">
      <div class="card-label">API Key</div>
      <div class="api-row">
        <div class="api-status" id="api-status"></div>
        <input type="password" id="api-key-input" placeholder="sk-ant-api03-â€¦" style="flex:1" />
        <button class="key-toggle" id="key-toggle" title="Show/hide">ğŸ‘</button>
      </div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px;">Key is held in memory only and not persisted in the browser.</div>
    </div>

    <!-- Load Session -->
    <label class="load-strip" id="load-strip">
      <input type="file" id="load-file-input" accept=".json" onchange="loadSession(event)" />
      <div class="load-strip-icon">ğŸ“‚</div>
      <div class="load-strip-text">
        <div class="load-strip-title">Load Saved Session</div>
        <div class="load-strip-sub">Upload a previously saved quiz or flashcard session file to skip generation</div>
      </div>
      <div style="color:var(--muted);font-size:20px;">â€º</div>
    </label>

    <!-- Content -->
    <div class="card anim-2">
      <div class="card-label">Study Content</div>
      <textarea id="content-input" placeholder="Paste your notes, slide content, article, or any text here. Claude will read it and generate your sessionâ€¦"></textarea>
    </div>

    <!-- Settings â€” Quiz -->
    <div class="card anim-3" id="quiz-settings">
      <div class="card-label">Quiz Settings</div>
      <div class="setup-row">
        <div class="field-group" style="flex:1">
          <div class="field-label">Number of questions</div>
          <input type="number" id="num-questions" value="10" min="3" max="25" />
        </div>
        <div class="field-group" style="flex:1">
          <div class="field-label">Difficulty</div>
          <select id="difficulty" style="width:100%">
            <option value="standard">Standard</option>
            <option value="challenging">Challenging</option>
            <option value="easy">Easy</option>
          </select>
        </div>
        <div class="field-group">
          <button class="btn btn-primary" onclick="generateQuiz()">Generate Quiz âš¡</button>
        </div>
      </div>
      <div class="error-box" id="setup-error"></div>
    </div>

    <!-- Settings â€” Flashcard -->
    <div class="card anim-3" id="fc-settings" style="display:none">
      <div class="card-label">Flashcard Settings</div>
      <div class="setup-row">
        <div class="field-group" style="flex:1">
          <div class="field-label">Number of cards</div>
          <input type="number" id="num-cards" value="15" min="5" max="40" />
        </div>
        <div class="field-group">
          <button class="btn btn-primary" onclick="generateFlashcards()">Generate Flashcards ğŸƒ</button>
        </div>
      </div>
      <div class="error-box" id="fc-setup-error"></div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       LOADING SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screen-loading" class="screen">
    <div class="loading-screen">
      <div class="spinner"></div>
      <div class="loading-title" id="loading-title">Generating your quizâ€¦</div>
      <div class="loading-sub" id="loading-sub">Claude is reading your content and crafting questions.</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QUIZ SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screen-quiz" class="screen">
    <div class="progress-label">
      <span class="progress-text" id="progress-text">Question 1 of 10</span>
      <button class="btn btn-ghost" onclick="resetToSetup()">âœ• Exit</button>
    </div>
    <div class="progress-wrap">
      <div class="progress-fill" id="progress-fill" style="width:0%"></div>
    </div>
    <div id="question-area"></div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESULTS SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screen-results" class="screen">

    <div class="results-header">
      <div class="results-emoji" id="results-emoji">ğŸ‰</div>
      <div class="results-title" id="results-title">Quiz Complete!</div>
      <div class="results-sub" id="results-sub">Here's how you did:</div>
      <div class="score-badge">
        <div class="score-dot" id="score-dot"></div>
        <span id="score-text"></span>
      </div>
    </div>

    <!-- Study guide trigger -->
    <div id="study-guide-section" class="study-guide-section" style="display:none">
      <div style="text-align:center;margin-bottom:16px;">
        <button class="btn btn-teal" id="study-guide-btn" onclick="generateStudyGuide()">
          ğŸ“– Generate Study Guide for Missed Topics
        </button>
        <div style="font-size:12px;color:var(--muted);margin-top:8px;">Claude will explain the concepts you missed in student-friendly terms</div>
      </div>
      <!-- Collapsible panel â€” hidden until guide is ready -->
      <div class="sg-panel" id="sg-panel" style="display:none">
        <div class="sg-panel-header" onclick="toggleSgPanel()">
          <div class="sg-panel-icon">ğŸ“–</div>
          <div style="flex:1">
            <div class="sg-panel-title">Study Guide â€” Missed Topics</div>
            <div class="sg-panel-subtitle" id="sg-panel-subtitle">Click to expand</div>
          </div>
          <div class="sg-chevron">âŒ„</div>
        </div>
        <div class="sg-panel-body">
          <div class="sg-panel-inner">
            <div id="study-guide-output"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="review-list" id="review-list"></div>

    <div class="results-actions">
      <button class="btn btn-primary" onclick="tryAgain()">ğŸ”„ New Questions, Same Topic</button>
      <button class="btn btn-secondary" onclick="saveQuizSession()">ğŸ’¾ Save Session</button>
      <button class="btn btn-secondary" onclick="resetToSetup()">ğŸ“ New Content</button>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       FLASHCARD SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="screen-flashcard" class="screen">

    <div class="fc-progress-label">
      <span class="fc-counter" id="fc-counter">Card 1 of 15</span>
      <button class="btn btn-ghost" onclick="resetToSetup()">âœ• Exit</button>
    </div>
    <div class="progress-wrap">
      <div class="progress-fill" id="fc-progress-fill" style="width:0%"></div>
    </div>

    <!-- The card -->
    <div class="flashcard-scene" onclick="flipCard()">
      <div class="flashcard" id="flashcard">
        <div class="fc-face fc-front">
          <div class="fc-label">Definition</div>
          <div class="fc-text" id="fc-front-text">Loadingâ€¦</div>
          <div class="fc-hint">Tap to reveal the term</div>
        </div>
        <div class="fc-face fc-back">
          <div class="fc-label">Term</div>
          <div class="fc-text" id="fc-back-text">â€¦</div>
        </div>
      </div>
    </div>

    <div class="fc-flip-hint" id="fc-flip-hint">Tap the card to flip it</div>

    <div class="fc-nav">
      <button class="fc-nav-btn" id="fc-prev" onclick="fcNav(-1)" disabled>â€¹</button>
      <span style="font-family:'Syne',sans-serif;font-size:13px;color:var(--muted)" id="fc-nav-label">1 / 15</span>
      <button class="fc-nav-btn" id="fc-next" onclick="fcNav(1)">â€º</button>
    </div>

    <div class="fc-actions">
      <button class="btn btn-primary" onclick="shuffleAndRestart()">ğŸ”€ Shuffle & Restart</button>
      <button class="btn btn-secondary" onclick="saveFcSession()">ğŸ’¾ Save Session</button>
      <button class="btn btn-secondary" onclick="resetToSetup()">ğŸ“ New Content</button>
    </div>

  </div>

</div><!-- /container -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let appMode = 'quiz'; // 'quiz' | 'flashcard'

// Quiz state
let questions = [];
let currentQ = 0;
let answered = false;
let userAnswers = [];
let savedContent = '';
let savedNumQ = 10;
let savedDifficulty = 'standard';

// Flashcard state
let flashcards = [];
let fcIndex = 0;
let fcFlipped = false;
let savedNumCards = 15;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODE TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(mode) {
  appMode = mode;
  document.getElementById('mode-quiz-btn').classList.toggle('active', mode === 'quiz');
  document.getElementById('mode-fc-btn').classList.toggle('active', mode === 'flashcard');
  document.getElementById('quiz-settings').style.display = mode === 'quiz' ? 'block' : 'none';
  document.getElementById('fc-settings').style.display = mode === 'flashcard' ? 'block' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API KEY UX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const keyInput = document.getElementById('api-key-input');
const keyStatus = document.getElementById('api-status');
const keyToggle = document.getElementById('key-toggle');
let keyVisible = false;

keyInput.addEventListener('input', () => {
  keyStatus.className = 'api-status' + (keyInput.value.trim().startsWith('sk-ant') ? ' active' : '');
});
keyToggle.addEventListener('click', () => {
  keyVisible = !keyVisible;
  keyInput.type = keyVisible ? 'text' : 'password';
  keyToggle.textContent = keyVisible ? 'ğŸ™ˆ' : 'ğŸ‘';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN SWITCHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHARED API CALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callClaude(apiKey, prompt, maxTokens = 4000) {
  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: maxTokens,
      messages: [{ role: 'user', content: prompt }]
    })
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err?.error?.message || `API error ${res.status}`);
  }
  const data = await res.json();
  return data.content?.[0]?.text || '';
}

function parseJSON(raw) {
  raw = raw.replace(/```json/gi, '').replace(/```/g, '').trim();
  try { return JSON.parse(raw); } catch(e) {
    const match = raw.match(/\[[\s\S]*\]/);
    if (match) return JSON.parse(match[0]);
    throw new Error('Could not parse response data.');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateQuiz() {
  const apiKey = keyInput.value.trim();
  const content = document.getElementById('content-input').value.trim();
  const numQ = parseInt(document.getElementById('num-questions').value) || 10;
  const difficulty = document.getElementById('difficulty').value;
  const errBox = document.getElementById('setup-error');
  errBox.classList.remove('show');

  if (!apiKey) return showError(errBox, 'Please enter your Anthropic API key.');
  if (!apiKey.startsWith('sk-ant')) return showError(errBox, "That doesn't look like a valid Anthropic key (should start with sk-antâ€¦).");
  if (!content || content.length < 50) return showError(errBox, 'Please paste some study content â€” at least a few sentences.');

  savedContent = content;
  savedNumQ = numQ;
  savedDifficulty = difficulty;

  document.getElementById('loading-title').textContent = 'Generating your quizâ€¦';
  document.getElementById('loading-sub').textContent = 'Claude is reading your content and crafting questions.';
  showScreen('screen-loading');

  try {
    const raw = await callClaude(apiKey, buildQuizPrompt(content, numQ, difficulty));
    const parsed = parseJSON(raw);
    if (!Array.isArray(parsed) || !parsed.length) throw new Error('Received empty or invalid quiz data.');

    questions = parsed.map(q => {
      const choices = [q.correct, ...q.distractors].sort(() => Math.random() - 0.5);
      return { question: q.question, correct: q.correct, choices };
    });

    userAnswers = new Array(questions.length).fill(null);
    currentQ = 0;
    answered = false;
    showScreen('screen-quiz');
    renderQuestion();
  } catch(err) {
    showScreen('screen-setup');
    showError(document.getElementById('setup-error'), 'âš ï¸ ' + err.message);
  }
}

function buildQuizPrompt(content, numQ, difficulty) {
  const diffNote = {
    easy: 'Make the questions straightforward with clearly distinct answer choices. Target students encountering the material for the first time.',
    standard: 'Mix of recall and comprehension questions. Distractors should be plausible but clearly wrong to someone who studied.',
    challenging: 'Focus on deeper comprehension and application. Distractors should be very plausible â€” a student must truly understand the material to distinguish them.'
  }[difficulty];

  return `You are an expert quiz writer. Given the study content below, generate exactly ${numQ} multiple-choice questions.

DIFFICULTY: ${difficulty.toUpperCase()}
${diffNote}

CRITICAL RULES FOR DISTRACTORS (wrong answers):
1. Each distractor must be the SAME TYPE as the correct answer.
2. Distractors must be plausible â€” a student who hasn't studied might pick them, but someone who studied would know they're wrong.
3. Distractors must NOT be obviously silly or from a completely different topic.
4. Distractors should be roughly the same length and grammatical structure as the correct answer.
5. Never use "All of the above" or "None of the above".
6. Do NOT repeat the same distractor across questions.

OUTPUT FORMAT: Respond with ONLY a valid JSON array. No markdown, no code fences, no explanation.

[
  {
    "question": "Question text here?",
    "correct": "The correct answer",
    "distractors": ["Wrong but plausible 1", "Wrong but plausible 2", "Wrong but plausible 3"]
  }
]

STUDY CONTENT:
${content.slice(0, 12000)}`;
}

async function tryAgain() {
  const apiKey = keyInput.value.trim();
  if (!apiKey) { alert('Please re-enter your API key.'); resetToSetup(); return; }
  document.getElementById('loading-title').textContent = 'Generating new questionsâ€¦';
  document.getElementById('loading-sub').textContent = 'Same topic, fresh set of questions and distractors.';
  showScreen('screen-loading');
  try {
    const raw = await callClaude(apiKey, buildQuizPrompt(savedContent, savedNumQ, savedDifficulty));
    const parsed = parseJSON(raw);
    if (!Array.isArray(parsed) || !parsed.length) throw new Error('Received empty or invalid quiz data.');
    questions = parsed.map(q => {
      const choices = [q.correct, ...q.distractors].sort(() => Math.random() - 0.5);
      return { question: q.question, correct: q.correct, choices };
    });
    userAnswers = new Array(questions.length).fill(null);
    currentQ = 0; answered = false;
    showScreen('screen-quiz');
    renderQuestion();
  } catch(err) {
    showScreen('screen-results');
    alert('Error generating new questions: ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QUIZ RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQuestion() {
  const q = questions[currentQ];
  const total = questions.length;
  document.getElementById('progress-text').textContent = `Question ${currentQ + 1} of ${total}`;
  document.getElementById('progress-fill').style.width = `${(currentQ / total) * 100}%`;

  const letters = ['A','B','C','D','E'];
  document.getElementById('question-area').innerHTML = `
    <div class="card question-card">
      <div class="question-number">Question ${currentQ + 1} / ${total}</div>
      <div class="question-text">${escapeHtml(q.question)}</div>
      <div class="choices" id="choices">
        ${q.choices.map((c, i) => `
          <button class="choice" id="choice-${i}" onclick="selectAnswer(${i})">
            <div class="choice-letter">${letters[i]}</div>
            <div>${escapeHtml(c)}</div>
          </button>
        `).join('')}
      </div>
      <div id="feedback-area"></div>
    </div>
    <div class="next-row" id="next-row" style="display:none">
      <button class="btn btn-primary" onclick="nextQuestion()">
        ${currentQ + 1 === total ? 'See Results ğŸ¯' : 'Next Question â†’'}
      </button>
    </div>
  `;
  answered = false;
}

function selectAnswer(idx) {
  if (answered) return;
  answered = true;
  const q = questions[currentQ];
  const chosen = q.choices[idx];
  const isCorrect = chosen === q.correct;
  const correctIdx = q.choices.indexOf(q.correct);
  userAnswers[currentQ] = { chosen, isCorrect };

  q.choices.forEach((_, i) => document.getElementById(`choice-${i}`).disabled = true);

  const chosenBtn = document.getElementById(`choice-${idx}`);
  chosenBtn.classList.add(isCorrect ? 'correct' : 'wrong');
  const icon = document.createElement('span');
  icon.className = 'choice-icon';
  icon.textContent = isCorrect ? 'âœ“' : 'âœ—';
  chosenBtn.appendChild(icon);

  if (!isCorrect) {
    const correctBtn = document.getElementById(`choice-${correctIdx}`);
    correctBtn.classList.add('reveal-correct');
    const cIcon = document.createElement('span');
    cIcon.className = 'choice-icon'; cIcon.textContent = 'âœ“';
    correctBtn.appendChild(cIcon);
  }

  document.getElementById('feedback-area').innerHTML = `
    <div class="feedback ${isCorrect ? 'correct-fb' : 'wrong-fb'}">
      <span>${isCorrect ? 'âœ…' : 'âŒ'}</span>
      <span>${isCorrect ? 'Correct! Great job.' : `Not quite. The correct answer is: <strong>${escapeHtml(q.correct)}</strong>`}</span>
    </div>
  `;
  document.getElementById('next-row').style.display = 'flex';
}

function nextQuestion() {
  currentQ++;
  if (currentQ >= questions.length) showResults();
  else renderQuestion();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResults() {
  const total = questions.length;
  const correct = userAnswers.filter(a => a?.isCorrect).length;
  const pct = Math.round((correct / total) * 100);

  let emoji = 'ğŸ˜“', title = 'Keep Studying!';
  if (pct >= 90) { emoji = 'ğŸ†'; title = 'Outstanding!'; }
  else if (pct >= 75) { emoji = 'ğŸ‰'; title = 'Great Work!'; }
  else if (pct >= 60) { emoji = 'ğŸ‘'; title = 'Getting There!'; }
  else if (pct >= 40) { emoji = 'ğŸ“š'; title = 'Keep Practicing!'; }

  document.getElementById('results-emoji').textContent = emoji;
  document.getElementById('results-title').textContent = title;
  document.getElementById('results-sub').textContent = `You answered ${correct} out of ${total} correctly.`;
  document.getElementById('score-text').textContent = `${correct} / ${total} â€” ${pct}%`;
  document.getElementById('score-dot').style.background = pct >= 75 ? 'var(--correct)' : pct >= 50 ? '#ffb347' : 'var(--wrong)';

  // Show study guide button only if there are missed questions
  const missedCount = userAnswers.filter(a => a && !a.isCorrect).length;
  const sgSection = document.getElementById('study-guide-section');
  sgSection.style.display = missedCount > 0 ? 'block' : 'none';
  // Reset panel state
  const sgPanel = document.getElementById('sg-panel');
  sgPanel.style.display = 'none';
  sgPanel.classList.remove('open');
  document.getElementById('study-guide-output').innerHTML = '';
  const btn = document.getElementById('study-guide-btn');
  btn.disabled = false;
  btn.classList.remove('loading');
  btn.innerHTML = 'ğŸ“– Generate Study Guide for Missed Topics';

  document.getElementById('review-list').innerHTML = questions.map((q, i) => {
    const ans = userAnswers[i];
    const ok = ans?.isCorrect;
    return `
      <div class="review-item ${ok ? 'r-correct' : 'r-wrong'}" style="animation-delay:${i * 0.04}s">
        <div class="review-q"><span class="review-icon">${ok ? 'âœ…' : 'âŒ'}</span><span>${escapeHtml(q.question)}</span></div>
        <div class="review-answers">
          <div class="review-correct-ans">âœ“ ${escapeHtml(q.correct)}</div>
          ${!ok && ans ? `<div class="review-wrong-ans">âœ— You answered: ${escapeHtml(ans.chosen)}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');

  document.getElementById('progress-fill').style.width = '100%';
  showScreen('screen-results');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STUDY GUIDE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateStudyGuide() {
  const apiKey = keyInput.value.trim();
  if (!apiKey) { alert('API key not found. Please return to setup.'); return; }

  const missed = questions
    .map((q, i) => ({ q, ans: userAnswers[i] }))
    .filter(({ ans }) => ans && !ans.isCorrect);

  if (!missed.length) return;

  const btn = document.getElementById('study-guide-btn');
  btn.disabled = true;
  btn.classList.add('loading');
  btn.innerHTML = '<span class="btn-spinner"></span>Generating study guideâ€¦';

  const missedSummary = missed.map(({ q, ans }) =>
    `Question: ${q.question}\nCorrect answer: ${q.correct}\nStudent answered: ${ans.chosen}`
  ).join('\n\n');

  const prompt = `You are a patient, encouraging tutor. A student just took a quiz and got the following questions wrong. 

For each missed question, write a focused study guide section that:
1. Explains the concept clearly in plain, student-friendly language
2. Clarifies WHY the correct answer is right
3. Explains why the student's wrong answer was a common misconception
4. Gives a memory tip, analogy, or real-world example to help it stick

Format your response using this structure for each topic:
### [Topic/Concept Name]
Then write 2-3 paragraphs of explanation. Keep it encouraging and clear. Do not use JSON â€” write in plain readable text with markdown headings.

MISSED QUESTIONS:
${missedSummary}`;

  // â”€â”€ Show panel with skeleton immediately â”€â”€
  const panel = document.getElementById('sg-panel');
  const output = document.getElementById('study-guide-output');
  panel.style.display = 'block';
  panel.classList.add('open');

  // Skeleton shimmer placeholder
  output.innerHTML = `
    <div class="sg-skeleton">
      <div class="sg-skel-bar title"></div>
      <div class="sg-skel-bar full"></div>
      <div class="sg-skel-bar full"></div>
      <div class="sg-skel-bar med"></div>
      <div class="sg-skel-bar short" style="margin-top:8px"></div>
      <div class="sg-skel-bar title" style="margin-top:16px"></div>
      <div class="sg-skel-bar full"></div>
      <div class="sg-skel-bar full"></div>
      <div class="sg-skel-bar med"></div>
      <div class="sg-skel-bar short" style="margin-top:8px"></div>
    </div>
  `;

  // Scroll panel into view
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  try {
    const raw = await callClaude(apiKey, prompt, 2000);

    // Render markdown â†’ HTML
    const html = raw
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/^- (.+)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>')
      .split('\n\n')
      .map(p => p.trim())
      .filter(Boolean)
      .map(p => p.startsWith('<h3>') || p.startsWith('<ul>') ? p : `<p>${p}</p>`)
      .join('\n');

    output.innerHTML = `
      <div class="sg-content">${html}</div>
      <div class="sg-divider"></div>
      <div class="sg-actions">
        <button class="btn btn-secondary btn-sm" onclick="downloadStudyGuide()">ğŸ’¾ Save Study Guide</button>
      </div>
    `;

    // Update panel subtitle with topic count
    document.getElementById('sg-panel-subtitle').textContent =
      `${missed.length} topic${missed.length > 1 ? 's' : ''} covered Â· Click to collapse`;

    btn.textContent = 'âœ… Study Guide Ready';
    btn.classList.remove('loading');

  } catch(err) {
    btn.disabled = false;
    btn.classList.remove('loading');
    btn.textContent = 'ğŸ“– Generate Study Guide for Missed Topics';
    output.innerHTML = `<div style="color:#ff8fa8;font-size:14px;">âš ï¸ ${err.message}</div>`;
  }
}

function toggleSgPanel() {
  document.getElementById('sg-panel').classList.toggle('open');
}

function downloadStudyGuide() {
  const content = document.querySelector('.study-guide-content');
  if (!content) return;
  // Convert back to plain text
  const text = content.innerText;
  downloadText('studypulse-study-guide.txt', text);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLASHCARD GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateFlashcards() {
  const apiKey = keyInput.value.trim();
  const content = document.getElementById('content-input').value.trim();
  const numCards = parseInt(document.getElementById('num-cards').value) || 15;
  const errBox = document.getElementById('fc-setup-error');
  errBox.classList.remove('show');

  if (!apiKey) return showError(errBox, 'Please enter your Anthropic API key.');
  if (!apiKey.startsWith('sk-ant')) return showError(errBox, "That doesn't look like a valid Anthropic key.");
  if (!content || content.length < 50) return showError(errBox, 'Please paste some study content.');

  savedContent = content;
  savedNumCards = numCards;

  document.getElementById('loading-title').textContent = 'Generating your flashcardsâ€¦';
  document.getElementById('loading-sub').textContent = 'Claude is extracting key terms and definitions.';
  showScreen('screen-loading');

  const prompt = `You are an expert study tool creator. From the study content below, extract exactly ${numCards} key term-definition pairs suitable for flashcards.

Rules:
1. The "term" should be a concise word or short phrase (1-5 words max).
2. The "definition" should be a clear, complete explanation in 1-3 sentences â€” written in plain student-friendly language.
3. Pick the most important, testable concepts from the content.
4. Do not repeat similar terms.
5. Definitions should stand alone â€” a student reading just the definition should be able to guess the term.

OUTPUT FORMAT: Respond with ONLY a valid JSON array. No markdown, no code fences, no explanation.

[
  {
    "term": "Photosynthesis",
    "definition": "The process by which plants use sunlight, water, and carbon dioxide to produce glucose and oxygen."
  }
]

STUDY CONTENT:
${content.slice(0, 12000)}`;

  try {
    const raw = await callClaude(apiKey, prompt, 3000);
    const parsed = parseJSON(raw);
    if (!Array.isArray(parsed) || !parsed.length) throw new Error('Received empty or invalid flashcard data.');

    flashcards = parsed.map(c => ({ term: c.term, definition: c.definition }));
    fcIndex = 0;
    fcFlipped = false;
    showScreen('screen-flashcard');
    renderFlashcard();
  } catch(err) {
    showScreen('screen-setup');
    showError(document.getElementById('fc-setup-error'), 'âš ï¸ ' + err.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLASHCARD RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFlashcard() {
  const card = flashcards[fcIndex];
  const total = flashcards.length;

  document.getElementById('fc-counter').textContent = `Card ${fcIndex + 1} of ${total}`;
  document.getElementById('fc-nav-label').textContent = `${fcIndex + 1} / ${total}`;
  document.getElementById('fc-progress-fill').style.width = `${((fcIndex + 1) / total) * 100}%`;

  document.getElementById('fc-front-text').textContent = card.definition;
  document.getElementById('fc-back-text').textContent = card.term;

  // Reset flip
  fcFlipped = false;
  document.getElementById('flashcard').classList.remove('flipped');

  // Nav buttons
  document.getElementById('fc-prev').disabled = fcIndex === 0;
  document.getElementById('fc-next').disabled = fcIndex === total - 1;
}

function flipCard() {
  fcFlipped = !fcFlipped;
  document.getElementById('flashcard').classList.toggle('flipped', fcFlipped);
  document.getElementById('fc-flip-hint').textContent = fcFlipped ? 'Tap again to flip back' : 'Tap the card to flip it';
}

function fcNav(dir) {
  const newIdx = fcIndex + dir;
  if (newIdx < 0 || newIdx >= flashcards.length) return;
  fcIndex = newIdx;
  renderFlashcard();
}

function shuffleAndRestart() {
  flashcards = flashcards.sort(() => Math.random() - 0.5);
  fcIndex = 0;
  renderFlashcard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE & LOAD SESSIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveQuizSession() {
  const apiKey = keyInput.value.trim();
  const session = {
    type: 'quiz',
    version: 1,
    savedAt: new Date().toISOString(),
    apiKey,
    content: savedContent,
    numQuestions: savedNumQ,
    difficulty: savedDifficulty,
    questions: questions.map(q => ({
      question: q.question,
      correct: q.correct,
      distractors: q.choices.filter(c => c !== q.correct)
    }))
  };
  const name = `studypulse-quiz-${datestamp()}.json`;
  downloadJSON(name, session);
}

function saveFcSession() {
  const apiKey = keyInput.value.trim();
  const session = {
    type: 'flashcard',
    version: 1,
    savedAt: new Date().toISOString(),
    apiKey,
    content: savedContent,
    numCards: savedNumCards,
    cards: flashcards
  };
  const name = `studypulse-flashcards-${datestamp()}.json`;
  downloadJSON(name, session);
}

function loadSession(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const session = JSON.parse(e.target.result);
      if (!session.type || !session.version) throw new Error('Invalid session file.');

      // Restore API key
      if (session.apiKey) {
        keyInput.value = session.apiKey;
        keyStatus.className = 'api-status' + (session.apiKey.startsWith('sk-ant') ? ' active' : '');
      }

      // Restore content
      if (session.content) {
        document.getElementById('content-input').value = session.content;
        savedContent = session.content;
      }

      if (session.type === 'quiz') {
        savedNumQ = session.numQuestions || 10;
        savedDifficulty = session.difficulty || 'standard';
        document.getElementById('num-questions').value = savedNumQ;
        document.getElementById('difficulty').value = savedDifficulty;

        questions = session.questions.map(q => {
          const choices = [q.correct, ...q.distractors].sort(() => Math.random() - 0.5);
          return { question: q.question, correct: q.correct, choices };
        });
        userAnswers = new Array(questions.length).fill(null);
        currentQ = 0; answered = false;
        setMode('quiz');
        showScreen('screen-quiz');
        renderQuestion();

      } else if (session.type === 'flashcard') {
        savedNumCards = session.numCards || 15;
        document.getElementById('num-cards').value = savedNumCards;
        flashcards = session.cards || [];
        fcIndex = 0; fcFlipped = false;
        setMode('flashcard');
        showScreen('screen-flashcard');
        renderFlashcard();
      } else {
        throw new Error('Unknown session type.');
      }
    } catch(err) {
      alert('Could not load session: ' + err.message);
    }
    // Reset file input so same file can be loaded again
    event.target.value = '';
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function resetToSetup() {
  questions = []; userAnswers = []; currentQ = 0; answered = false;
  flashcards = []; fcIndex = 0; fcFlipped = false;
  showScreen('screen-setup');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showError(el, msg) { el.textContent = msg; el.classList.add('show'); }

function escapeHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function downloadJSON(filename, obj) {
  const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function downloadText(filename, text) {
  const blob = new Blob([text], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function datestamp() {
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
}
</script>
</body>
</html>
